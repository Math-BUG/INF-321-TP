// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
}

datasource db {
  provider = "sqlite"
}

model Challenge {
  id           Int       @id @default(autoincrement())
  name         String    @unique
  identifier   String?   @unique @default(cuid())
  description  String?
  requirements String?
  instructions String?
  isStatic     Int       @default(0) // 0/1 (DER: is_static : INTEGER)
  createdAt    DateTime  @default(now())

  // relations
  levels       Level[]

  @@map("challenges")
}

model Parameter {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  identifier  String?  @unique @default(cuid())

  // relations
  levelValues LevelParameterValue[]
  @@map("parameters")
}

model Level {
  id            Int      @id @default(autoincrement())
  challengeId   Int
  name          String   @unique
  numRounds     Int
  timePerRound  Int
  createdAt     DateTime @default(now())

  // relations
  challenge     Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  parameterVals LevelParameterValue[]
  matches       Match[]

  @@index([challengeId])
  @@map("levels")
}

model LevelParameterValue {
  id          Int      @id @default(autoincrement())
  levelId     Int
  parameterId Int
  value       String?
  createdAt   DateTime @default(now())

  // relations
  level       Level     @relation(fields: [levelId], references: [id], onDelete: Cascade)
  parameter   Parameter @relation(fields: [parameterId], references: [id], onDelete: Cascade)

  // DER: UNIQUE(level_id, parameter_id)
  @@unique([levelId, parameterId])

  @@index([levelId])
  @@index([parameterId])
  @@map("level_parameter_values")
}

model User {
  id              Int      @id @default(autoincrement())
  name            String
  email           String   @unique
  passwordHash    String
  isAdmin         Int      @default(0) 
  sex             String?
  phone           String?
  birthdate       DateTime? 
  address         String?
  musicExperience String?
  createdAt       DateTime  @default(now())

  // relations
  matches         Match[]

  @@map("users")
}

model Match {
  id            Int      @id @default(autoincrement())
  userId        Int
  levelId       Int
  startedAt     DateTime @default(now())
  finishedAt    DateTime?
  isComplete    Int      @default(0) // 0/1 (DER: is_complete : INTEGER)
  totalRounds   Int?
  currentRound  Int?
  score         Int?
  totalCorrect  Int?
  totalIncorrect Int?
  stateJson     String?

  // relations
  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  level         Level  @relation(fields: [levelId], references: [id])
  rounds        Round[]

  @@index([userId])
  @@index([levelId])
  @@map("matches")
}

model Round {
  id            Int      @id @default(autoincrement())
  matchId       Int
  roundNumber   Int
  prompt        String?
  optionsJson   String?
  correctOption Int?
  chosenOption  Int?
  timeTaken     Int?
  isCorrect     Int?     // 0/1 no DER (INTEGER)
  createdAt     DateTime @default(now())

  // relations
  match         Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  
  @@unique([matchId, roundNumber])

  @@index([matchId])
  @@map("rounds")
}
